<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>—÷« „— ÷Ê? - Â‰—„‰œ Ê „œ—”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Markazi+Text&family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            scroll-behavior: smooth;
        }
        .font-lalezar { font-family: 'Lalezar', cursive; }
        .font-markazi { font-family: 'Markazi Text', serif; }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        [contenteditable="true"]:hover {
            outline: 2px dashed #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        [contenteditable="true"]:focus {
            outline: 2px solid #2563eb; /* blue-600 */
            background-color: #dbeafe; /* blue-100 */
        }
        .admin-controls { display: none; }
        body.admin-mode .admin-controls { display: block; }
        body.admin-mode .editable-text { border: 1px dashed #cccccc; padding: 5px; cursor: text;}

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .image-container:hover img {
            transform: scale(1.05);
        }
        .delete-btn {
            position: absolute;
            top: 8px;
            left: 8px; /* Adjusted for RTL */
            background-color: rgba(239, 68, 68, 0.8); /* bg-red-500 with opacity */
            color: white;
            border: none;
            border-radius: 9999px; /* rounded-full */
            width: 32px; /* w-8 */
            height: 32px; /* h-8 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px; /* text-lg */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .image-container:hover .delete-btn {
            opacity: 1;
        }
        .add-image-placeholder {
            border: 2px dashed #cbd5e1; /* border-slate-300 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px; /* Or adjust as needed */
            cursor: pointer;
            background-color: #f8fafc; /* bg-slate-50 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .add-image-placeholder:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        #loadingIndicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loadingIndicator" style="display: none;">œ— Õ«· »«—ê–«—?...</div>

    <button id="adminToggleBtn" class="fixed top-4 left-4 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300">
        Ê—Êœ »Â Õ«·  „œ?—? 
    </button>
    <div id="userIdDisplay" class="fixed top-16 left-4 bg-gray-700 text-white py-1 px-3 rounded-md text-xs z-50 admin-controls">‘‰«”Â ò«—»—?: <span id="currentUserId"></span></div>


    <header id="mainHeader" class="bg-white shadow-md sticky top-0 z-40 transition-all duration-500">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 id="siteName" class="text-3xl font-lalezar text-indigo-600 editable-text" data-field="name">—÷« „— ÷Ê?</h1>
            <nav>
                <ul class="flex space-x-reverse space-x-4">
                    <li><a href="#about" class="text-gray-600 hover:text-indigo-500 transition-colors">œ—»«—Â „‰</a></li>
                    <li><a href="#portfolio" class="text-gray-600 hover:text-indigo-500 transition-colors">‰„Ê‰Â ò«—Â«</a></li>
                    <li><a href="#classes" class="text-gray-600 hover:text-indigo-500 transition-colors">ò·«”ùÂ«? ¬„Ê“‘?</a></li>
                    <li><a href="#contact" class="text-gray-600 hover:text-indigo-500 transition-colors"> „«” »« „‰</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="settingsPanel" class="admin-controls fixed top-0 right-0 h-full w-80 bg-gray-800 text-white p-6 shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
        <button id="closeSettingsPanel" class="absolute top-4 left-4 text-2xl">&times;</button>
        <h2 class="text-2xl font-lalezar mb-6 border-b pb-2 border-gray-700"> ‰Ÿ?„«  ”«? </h2>

        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Å”ù“„?‰Â «’·? ”«? </h3>
            <label for="bgImageUpload" class="block mb-1 text-sm">»«—ê–«—? ⁄ò” Å”ù“„?‰Â:</label>
            <input type="file" id="bgImageUpload" accept="image/*" class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-2">
            <label for="bgSizeSelect" class="block mb-1 text-sm">‰ÕÊÂ ‰„«?‘ Å”ù“„?‰Â:</label>
            <select id="bgSizeSelect" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-indigo-500">
                <option value="cover">ÅÊ‘‘ ò«„· (Cover)</option>
                <option value="contain">„ ‰«”» (Contain)</option>
                <option value="auto">ŒÊœò«— (Auto)</option>
            </select>
            <button id="saveBackgroundSettings" class="mt-3 w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-colors">–Œ?—Â  ‰Ÿ?„«  Å”ù“„?‰Â</button>
        </div>
        <p class="text-xs text-gray-400 mt-4"> €??—«  „ ‰ùÂ« »« ò·?ò Œ«—Ã «“ ò«œ— „ ‰ –Œ?—Â „?ù‘Êœ.</p>
    </div>


    <section id="hero" class="min-h-screen flex items-center justify-center text-center bg-cover bg-center bg-fixed transition-all duration-1000" style="background-image: url('https://placehold.co/1920x1080/667eea/ffffff?text=Â‰—+„‰');">
        <div class="bg-black bg-opacity-50 p-8 md:p-12 rounded-lg">
            <h2 id="heroTitle" class="text-4xl md:text-6xl font-lalezar text-white mb-4 editable-text" data-field="heroTitle">Â‰—°  Ã·? —ÊÕ</h2>
            <p id="heroSubtitle" class="text-lg md:text-xl text-gray-200 mb-8 editable-text" data-field="heroSubtitle">ò«Ê‘? œ— œ‰?«? ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? »« —÷« „— ÷Ê?.</p>
            <a href="#portfolio" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105">„‘«ÂœÂ ‰„Ê‰Â ò«—Â«</a>
        </div>
    </section>

    <section id="about" class="py-16 md:py-24 bg-white">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl md:text-4xl font-lalezar text-center text-gray-800 mb-12">œ—»«—Â „‰</h2>
            <div class="flex flex-col md:flex-row items-center gap-8 md:gap-12">
                <div class="md:w-1/3 text-center">
                    <div id="aboutImageContainer" class="w-64 h-64 md:w-80 md:h-80 mx-auto rounded-full overflow-hidden shadow-xl border-4 border-indigo-300 image-container">
                        <img id="aboutImage" src="https://placehold.co/400x400/cccccc/969696?text=⁄ò”+„‰" alt="—÷« „— ÷Ê?" class="object-cover w-full h-full">
                        <button class="delete-btn admin-controls" data-section="aboutImage" title="Õ–› ⁄ò” œ—»«—Â „‰">&times;</button>
                    </div>
                    <label for="aboutImageUpload" class="admin-controls mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md cursor-pointer transition-colors"> €??— ⁄ò” Å—Ê›«?·</label>
                    <input type="file" id="aboutImageUpload" accept="image/*" class="hidden">
                </div>
                <div class="md:w-2/3">
                    <p id="aboutText" class="text-lg text-gray-700 leading-relaxed editable-text" data-field="aboutText">
                        ”·«„! „‰ —÷« „— ÷Ê? Â” „. ”«·ùÂ«”  òÂ »« ⁄‘ﬁ Ê ⁄·«ﬁÂ œ— “„?‰Â Â‰—Â«?  Ã”„?° »ÂùÊ?éÂ ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? ›⁄«·?  „?ùò‰„. Â‰— »—«? „‰ ‰Â  ‰Â« ?ò Õ—›Â° »·òÂ —«Â? »—«? »?«‰ «Õ”«”«  Ê œ?œê«ÂùÂ«?„ »Â ÃÂ«‰ Å?—«„Ê‰ «” . „› Œ—„ òÂ  Ã—»?«  Ê œ«‰‘ ŒÊœ —« «“ ÿ—?ﬁ  œ—?” Õ—›Âù«? «?‰ —‘ ÂùÂ« »« Â‰—ÃÊ?«‰ ⁄·«ﬁÂù„‰œ »Â «‘ —«ò „?ùê–«—„ Ê ‘«Âœ ‘òÊ›«?? «” ⁄œ«œÂ«?‘«‰ Â” „.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="portfolio" class="py-16 md:py-24 bg-gray-50">
        <div class="container mx-auto px-6">
            <div class="flex justify-between items-center mb-12">
                <h2 id="portfolioTitle" class="text-3xl md:text-4xl font-lalezar text-gray-800 editable-text" data-field="portfolioTitle">‰„Ê‰Â ò«—Â«</h2>
                <label for="portfolioImageUpload" class="admin-controls bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md cursor-pointer transition-colors">«›“Êœ‰ ⁄ò” »Â ‰„Ê‰Â ò«—Â«</label>
                <input type="file" id="portfolioImageUpload" accept="image/*" class="hidden" multiple>
            </div>
            <div id="portfolioGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="add-image-placeholder admin-controls" onclick="document.getElementById('portfolioImageUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    <span>«›“Êœ‰ ⁄ò”</span>
                </div>
            </div>
        </div>
    </section>

    <section id="classes" class="py-16 md:py-24 bg-white">
        <div class="container mx-auto px-6">
             <div class="flex justify-between items-center mb-12">
                <h2 id="classesTitle" class="text-3xl md:text-4xl font-lalezar text-gray-800 editable-text" data-field="classesTitle">ò·«”ùÂ«? ¬„Ê“‘?</h2>
                <label for="classImageUpload" class="admin-controls bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md cursor-pointer transition-colors">«›“Êœ‰ ⁄ò” »Â ò·«”ùÂ«</label>
                <input type="file" id="classImageUpload" accept="image/*" class="hidden" multiple>
            </div>
            <p id="classesText" class="text-lg text-center text-gray-700 mb-12 leading-relaxed max-w-3xl mx-auto editable-text" data-field="classesText">
                œ— ò·«”ùÂ«? ¬„Ê“‘? „‰° ‘„« »« «’Ê· Ê  ò‰?òùÂ«? Õ—›Âù«? ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? ¬‘‰« ŒÊ«Â?œ ‘œ. Âœ› „‰ «?Ã«œ ›÷«?? ÅÊ?« Ê Œ·«ﬁ »—«? —‘œ «” ⁄œ«œÂ«? ‘„«” . »—«? «ÿ·«⁄«  »?‘ — œ—»«—Â œÊ—ÂùÂ« Ê À» ù‰«„ »« „‰  „«” »ê?—?œ.
            </p>
            <div id="classesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="add-image-placeholder admin-controls" onclick="document.getElementById('classImageUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    <span>«›“Êœ‰ ⁄ò”</span>
                </div>
            </div>
        </div>
    </section>

    <section id="contact" class="py-16 md:py-24 bg-indigo-700 text-white">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl md:text-4xl font-lalezar mb-8"> „«” »« „‰</h2>
            <div class="max-w-lg mx-auto">
                <p class="text-lg mb-4">»—«? „‘«Ê—Â° À» ù‰«„ œ— ò·«”ùÂ« Ê ?« ”›«—‘ ò«—° „?ù Ê«‰?œ «“ ÿ—?ﬁ —«ÂùÂ«? “?— »« „‰ œ— «— »«ÿ »«‘?œ:</p>
                <div class="space-y-3">
                    <p><strong> ·›‰:</strong> <span id="contactPhone" class="editable-text" data-field="phone">09374558557</span></p>
                    <p><strong>¬œ—”:</strong> <span id="contactAddress" class="editable-text" data-field="address">Œ«‰? ¬»«œ ‰Ê° Œ?«»«‰ ‘Â?œ ·ÿ?›?° Œ?«»«‰ »«ﬁ—?«‰° Å·«ò 6</span></p>
                    <p><strong>«?„?·:</strong> <span id="contactEmail" class="editable-text" data-field="email">«?„?· ŒÊœ —« Ê«—œ ò‰?œ</span></p>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-gray-300 text-center py-8">
        <p>&copy; <span id="currentYear"></span> —÷« „— ÷Ê?.  „«„? ÕﬁÊﬁ „Õ›ÊŸ «” .</p>
        <p class="text-xs mt-1">ÿ—«Õ? Ê  Ê”⁄Â  Ê”ÿ ÂÊ‘ „’‰Ê⁄? Gemini</p>
    </footer>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, addDoc, getDocs, serverTimestamp, query, orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        let userId = null;
        let isAdminMode = false;
        const loadingIndicator = document.getElementById('loadingIndicator');

        function showLoading(message = 'œ— Õ«· »«—ê–«—?...') {
            loadingIndicator.textContent = message;
            loadingIndicator.style.display = 'flex';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            showLoading('œ— Õ«· «Õ—«“ ÂÊ? ...');
            if (user) {
                userId = user.uid;
                console.log("User authenticated with UID:", userId);
                document.getElementById('currentUserId').textContent = userId;
                await loadAllData();
                setupAdminControls(); 
            } else {
                console.log("User not signed in. Attempting to sign in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await signInWithCustomToken(auth, __initial_auth_token);
                         console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    // Avoid using alert in production, use a custom modal or notification
                    // For this example, we'll keep it to show the error clearly during development
                    const userAlert = document.createElement('div');
                    userAlert.textContent = "Œÿ« œ— Ê—Êœ »Â ”?” „. ·ÿ›« ’›ÕÂ —« —›—‘ ò‰?œ.";
                    userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                    document.body.appendChild(userAlert);
                    setTimeout(() => userAlert.remove(), 5000);
                    hideLoading();
                }
            }
        });

        // --- Data Paths ---
        const getUserSiteDataDocRef = () => {
            if (!userId) throw new Error("User ID is not available for Firestore path.");
            return doc(db, `artifacts/${appId}/public/data/userSiteData/${userId}`);
        }
        const getPortfolioImagesColRef = () => {
            if (!userId) throw new Error("User ID is not available for Firestore path.");
            return collection(db, `artifacts/${appId}/public/data/userSiteData/${userId}/portfolioImages`);
        }
        const getClassImagesColRef = () => {
            if (!userId) throw new Error("User ID is not available for Firestore path.");
            return collection(db, `artifacts/${appId}/public/data/userSiteData/${userId}/classImages`);
        }


        // --- Load Data ---
        async function loadAllData() {
            if (!userId) return;
            showLoading('œ— Õ«· »«—ê?—? «ÿ·«⁄«  ”«? ...');

            try {
                const userSiteDataRef = getUserSiteDataDocRef();
                onSnapshot(userSiteDataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('siteName').textContent = data.name || '—÷« „— ÷Ê?';
                        document.getElementById('contactPhone').textContent = data.phone || '09374558557';
                        document.getElementById('contactAddress').textContent = data.address || 'Œ«‰? ¬»«œ ‰Ê...';
                        document.getElementById('contactEmail').textContent = data.email || '«?„?· ŒÊœ —« Ê«—œ ò‰?œ';
                        
                        if (data.backgroundImageUrl) {
                            document.getElementById('hero').style.backgroundImage = `url('${data.backgroundImageUrl}')`;
                        } else {
                            document.getElementById('hero').style.backgroundImage = `url('https://placehold.co/1920x1080/667eea/ffffff?text=Â‰—+„‰')`;
                        }
                        if (data.backgroundSize) {
                            document.getElementById('hero').style.backgroundSize = data.backgroundSize;
                            document.getElementById('bgSizeSelect').value = data.backgroundSize;
                        } else {
                             document.getElementById('hero').style.backgroundSize = 'cover';
                             document.getElementById('bgSizeSelect').value = 'cover';
                        }

                        document.getElementById('heroTitle').textContent = data.heroTitle || 'Â‰—°  Ã·? —ÊÕ';
                        document.getElementById('heroSubtitle').textContent = data.heroSubtitle || 'ò«Ê‘? œ— œ‰?«? ”?«Â ﬁ·„...';
                        document.getElementById('aboutText').textContent = data.aboutText || '”·«„! „‰ —÷« „— ÷Ê? Â” „...';
                        document.getElementById('portfolioTitle').textContent = data.portfolioTitle || '‰„Ê‰Â ò«—Â«';
                        document.getElementById('classesTitle').textContent = data.classesTitle || 'ò·«”ùÂ«? ¬„Ê“‘?';
                        document.getElementById('classesText').textContent = data.classesText || 'œ— ò·«”ùÂ«? ¬„Ê“‘? „‰...';

                        const imgEl = document.getElementById('aboutImage');
                        if (data.aboutImageUrl) {
                            imgEl.src = data.aboutImageUrl;
                        } else {
                            imgEl.src = 'https://placehold.co/400x400/cccccc/969696?text=⁄ò”+„‰';
                        }

                    } else {
                        // Initialize the single document with all default fields
                        setDoc(userSiteDataRef, {
                            name: '—÷« „— ÷Ê?',
                            phone: '09374558557',
                            address: 'Œ«‰? ¬»«œ ‰Ê° Œ?«»«‰ ‘Â?œ ·ÿ?›?° Œ?«»«‰ »«ﬁ—?«‰° Å·«ò 6',
                            email: '«?„?· ŒÊœ —« Ê«—œ ò‰?œ',
                            backgroundImageUrl: 'https://placehold.co/1920x1080/667eea/ffffff?text=Â‰—+„‰',
                            backgroundSize: 'cover',
                            heroTitle: 'Â‰—°  Ã·? —ÊÕ',
                            heroSubtitle: 'ò«Ê‘? œ— œ‰?«? ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? »« —÷« „— ÷Ê?.',
                            aboutText: '”·«„! „‰ —÷« „— ÷Ê? Â” „. ”«·ùÂ«”  òÂ »« ⁄‘ﬁ Ê ⁄·«ﬁÂ œ— “„?‰Â Â‰—Â«?  Ã”„?° »ÂùÊ?éÂ ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? ›⁄«·?  „?ùò‰„. Â‰— »—«? „‰ ‰Â  ‰Â« ?ò Õ—›Â° »·òÂ —«Â? »—«? »?«‰ «Õ”«”«  Ê œ?œê«ÂùÂ«?„ »Â ÃÂ«‰ Å?—«„Ê‰ «” . „› Œ—„ òÂ  Ã—»?«  Ê œ«‰‘ ŒÊœ —« «“ ÿ—?ﬁ  œ—?” Õ—›Âù«? «?‰ —‘ ÂùÂ« »« Â‰—ÃÊ?«‰ ⁄·«ﬁÂù„‰œ »Â «‘ —«ò „?ùê–«—„ Ê ‘«Âœ ‘òÊ›«?? «” ⁄œ«œÂ«?‘«‰ Â” „.',
                            portfolioTitle: '‰„Ê‰Â ò«—Â«',
                            classesTitle: 'ò·«”ùÂ«? ¬„Ê“‘?',
                            classesText: 'œ— ò·«”ùÂ«? ¬„Ê“‘? „‰° ‘„« »« «’Ê· Ê  ò‰?òùÂ«? Õ—›Âù«? ”?«Â ﬁ·„° —‰ê —Ê€‰ Ê ÿ—«Õ? ¬‘‰« ŒÊ«Â?œ ‘œ. Âœ› „‰ «?Ã«œ ›÷«?? ÅÊ?« Ê Œ·«ﬁ »—«? —‘œ «” ⁄œ«œÂ«? ‘„«” . »—«? «ÿ·«⁄«  »?‘ — œ—»«—Â œÊ—ÂùÂ« Ê À» ù‰«„ »« „‰  „«” »ê?—?œ.',
                            aboutImageUrl: 'https://placehold.co/400x400/cccccc/969696?text=⁄ò”+„‰',
                            timestamp: serverTimestamp() 
                        }).catch(e => console.error("Error initializing user site data:", e));
                    }
                }, error => console.error("Error loading user site data:", error));

                // Load portfolio images
                const portfolioQuery = query(getPortfolioImagesColRef(), orderBy("timestamp", "desc"));
                onSnapshot(portfolioQuery, (snapshot) => {
                    const grid = document.getElementById('portfolioGrid');
                    grid.querySelectorAll('.image-container').forEach(el => el.remove());
                    snapshot.forEach(doc => {
                        renderImage(grid, doc.data().imageUrl, doc.id, 'portfolioImages');
                    });
                }, error => console.error("Error loading portfolio images:", error));

                // Load class images
                const classesQuery = query(getClassImagesColRef(), orderBy("timestamp", "desc"));
                onSnapshot(classesQuery, (snapshot) => {
                    const grid = document.getElementById('classesGrid');
                    grid.querySelectorAll('.image-container').forEach(el => el.remove());
                    snapshot.forEach(doc => {
                        renderImage(grid, doc.data().imageUrl, doc.id, 'classImages');
                    });
                }, error => console.error("Error loading class images:", error));
            
            } catch (error) {
                console.error("Error in loadAllData (likely due to missing userId):", error);
            } finally {
                hideLoading();
            }
        }

        // --- Save Data ---
        async function updateField(field, value) {
            if (!userId) return;
            try {
                await updateDoc(getUserSiteDataDocRef(), { [field]: value, lastUpdated: serverTimestamp() });
                console.log(`${field} updated successfully.`);
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
            }
        }
        
        // --- Image Handling ---
        function renderImage(gridElement, imageUrl, imageId, collectionName) {
            const div = document.createElement('div');
            div.className = 'image-container shadow-lg aspect-square';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = ' ’Ê?— ‰„Ê‰Â ò«—'; 
            img.className = 'w-full h-full object-cover rounded-lg';
            img.onerror = () => { img.src = 'https://placehold.co/300x300/ff0000/ffffff?text=Œÿ«+œ—+»«—ê–«—?'; }

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '&times;';
            deleteButton.className = 'delete-btn admin-controls';
            deleteButton.title = 'Õ–› ⁄ò”';
            deleteButton.onclick = () => deleteGalleryImage(imageId, collectionName, imageUrl);

            div.appendChild(img);
            div.appendChild(deleteButton);
            gridElement.insertBefore(div, gridElement.firstChild);
        }

        // Uploads image to a gallery (portfolio, classes)
        async function uploadGalleryImage(file, collectionName) {
            if (!userId || !file) return;
            showLoading('œ— Õ«· »«—ê–«—? ⁄ò”...');

            const fileName = `images/${userId}/${collectionName}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, fileName);

            try {
                const base64Image = await toBase64(file);
                const uploadTask = await uploadString(storageRef, base64Image, 'data_url');
                const downloadURL = await getDownloadURL(uploadTask.ref);

                const colRef = collectionName === 'portfolioImages' ? getPortfolioImagesColRef() : getClassImagesColRef();
                await addDoc(colRef, { imageUrl: downloadURL, timestamp: serverTimestamp() });
                
                console.log(`${collectionName} image uploaded successfully: ${downloadURL}`);
            } catch (error) {
                console.error(`Error uploading ${collectionName} image:`, error);
                // Custom alert for user
                const userAlert = document.createElement('div');
                userAlert.textContent = 'Œÿ« œ— »«—ê–«—? ⁄ò”.';
                userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                document.body.appendChild(userAlert);
                setTimeout(() => userAlert.remove(), 3000);
            } finally {
                hideLoading();
            }
        }
        
        // Deletes an image from a gallery
        async function deleteGalleryImage(imageId, collectionName, imageUrl) {
            if (!userId) return;
            
            // Custom confirm dialog
            const confirmModal = createConfirmModal('¬?« «“ Õ–› «?‰  ’Ê?— „ÿ„∆‰ Â” ?œø', async () => {
                showLoading('œ— Õ«· Õ–› ⁄ò”...');
                try {
                    const colRef = collectionName === 'portfolioImages' ? getPortfolioImagesColRef() : getClassImagesColRef();
                    const docToDeleteRef = doc(colRef, imageId);
                    await deleteDoc(docToDeleteRef);

                    if (imageUrl && imageUrl.startsWith("https://firebasestorage.googleapis.com/")) {
                        const storageRef = ref(storage, imageUrl);
                        await deleteObject(storageRef);
                    }
                    console.log(`Image ${imageId} from ${collectionName} deleted.`);
                } catch (error) {
                    console.error(`Error deleting image ${imageId} from ${collectionName}:`, error);
                     const userAlert = document.createElement('div');
                    userAlert.textContent = 'Œÿ« œ— Õ–› ⁄ò”.';
                    userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                    document.body.appendChild(userAlert);
                    setTimeout(() => userAlert.remove(), 3000);
                } finally {
                    hideLoading();
                }
            });
            document.body.appendChild(confirmModal);
        }

        // Helper to convert file to Base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- Admin Mode and UI Setup ---
        function setupAdminControls() {
            if (!userId) return;

            const adminToggleBtn = document.getElementById('adminToggleBtn');
            const settingsPanel = document.getElementById('settingsPanel');
            const closeSettingsPanelBtn = document.getElementById('closeSettingsPanel');
            
            adminToggleBtn.onclick = () => {
                isAdminMode = !isAdminMode;
                document.body.classList.toggle('admin-mode', isAdminMode);
                adminToggleBtn.textContent = isAdminMode ? 'Œ—ÊÃ «“ Õ«·  „œ?—? ' : 'Ê—Êœ »Â Õ«·  „œ?—? ';
                if (isAdminMode) {
                    settingsPanel.classList.remove('translate-x-full');
                    settingsPanel.classList.add('translate-x-0');
                } else {
                    settingsPanel.classList.add('translate-x-full');
                    settingsPanel.classList.remove('translate-x-0');
                }
                makeTextsEditable(isAdminMode);
            };

            closeSettingsPanelBtn.onclick = () => {
                 settingsPanel.classList.add('translate-x-full');
                 settingsPanel.classList.remove('translate-x-0');
            };

            makeTextsEditable(false); 

            // Background image settings
            document.getElementById('bgImageUpload').onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    showLoading('œ— Õ«· »«—ê–«—? Å” “„?‰Â...');
                    const fileName = `backgrounds/${userId}/${Date.now()}_${file.name}`;
                    const storageRefInstance = ref(storage, fileName);
                    try {
                        const base64Image = await toBase64(file);
                        const uploadTask = await uploadString(storageRefInstance, base64Image, 'data_url');
                        const downloadURL = await getDownloadURL(uploadTask.ref);
                        await updateDoc(getUserSiteDataDocRef(), { backgroundImageUrl: downloadURL, lastUpdated: serverTimestamp() });
                        document.getElementById('hero').style.backgroundImage = `url('${downloadURL}')`;
                        console.log("Background image updated.");
                    } catch (error) {
                        console.error("Error uploading background image:", error);
                        const userAlert = document.createElement('div');
                        userAlert.textContent = "Œÿ« œ— »«—ê–«—?  ’Ê?— Å” “„?‰Â.";
                        userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                        document.body.appendChild(userAlert);
                        setTimeout(() => userAlert.remove(), 3000);
                    } finally {
                        hideLoading();
                    }
                }
            };
            document.getElementById('saveBackgroundSettings').onclick = async () => {
                 const size = document.getElementById('bgSizeSelect').value;
                 try {
                    await updateDoc(getUserSiteDataDocRef(), { backgroundSize: size, lastUpdated: serverTimestamp() });
                    document.getElementById('hero').style.backgroundSize = size;
                    console.log("Background size updated.");
                    const userAlert = document.createElement('div');
                    userAlert.textContent = " ‰Ÿ?„«  Å” “„?‰Â –Œ?—Â ‘œ.";
                    userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:green; color:white; padding:10px; border-radius:5px; z-index:10000;";
                    document.body.appendChild(userAlert);
                    setTimeout(() => userAlert.remove(), 3000);
                 } catch(e) {
                    console.error("Error saving background size: ", e);
                     const userAlert = document.createElement('div');
                    userAlert.textContent = "Œÿ« œ— –Œ?—Â  ‰Ÿ?„«  Å” “„?‰Â.";
                    userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                    document.body.appendChild(userAlert);
                    setTimeout(() => userAlert.remove(), 3000);
                 }
            };

            // About Me image upload
            document.getElementById('aboutImageUpload').onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    showLoading('œ— Õ«· »«—ê–«—? ⁄ò” Å—Ê›«?·...');
                    const fileName = `profileImages/${userId}/${Date.now()}_${file.name}`;
                    const storageRefInstance = ref(storage, fileName);
                    try {
                        const base64Image = await toBase64(file);
                        const uploadTask = await uploadString(storageRefInstance, base64Image, 'data_url');
                        const downloadURL = await getDownloadURL(uploadTask.ref);
                        await updateDoc(getUserSiteDataDocRef(), { aboutImageUrl: downloadURL, lastUpdated: serverTimestamp() });
                        document.getElementById('aboutImage').src = downloadURL;
                        console.log("About image updated.");
                    } catch (error) {
                        console.error("Error uploading about image:", error);
                         const userAlert = document.createElement('div');
                        userAlert.textContent = "Œÿ« œ— »«—ê–«—? ⁄ò” Å—Ê›«?·.";
                        userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                        document.body.appendChild(userAlert);
                        setTimeout(() => userAlert.remove(), 3000);
                    } finally {
                        hideLoading();
                    }
                }
            };
            
            const aboutImgContainer = document.getElementById('aboutImageContainer');
            const aboutImgDeleteBtn = aboutImgContainer.querySelector('.delete-btn');
            if(aboutImgDeleteBtn) {
                aboutImgDeleteBtn.onclick = async () => {
                    const currentImageSrc = document.getElementById('aboutImage').src;
                     if (currentImageSrc && !currentImageSrc.includes('placehold.co')) {
                        const confirmModal = createConfirmModal('¬?« «“ Õ–› ⁄ò” œ—»«—Â „‰ „ÿ„∆‰ Â” ?œø', async () => {
                            showLoading('œ— Õ«· Õ–› ⁄ò” Å—Ê›«?·...');
                            try {
                                // Delete from Storage first
                                const storageRefInstance = ref(storage, currentImageSrc);
                                await deleteObject(storageRefInstance);
                                // Then update Firestore
                                await updateDoc(getUserSiteDataDocRef(), { aboutImageUrl: '', lastUpdated: serverTimestamp() });
                                document.getElementById('aboutImage').src = 'https://placehold.co/400x400/cccccc/969696?text=⁄ò”+„‰';
                                console.log("About image deleted.");
                            } catch (error) {
                                console.error("Error deleting about image:", error);
                                const userAlert = document.createElement('div');
                                userAlert.textContent = "Œÿ« œ— Õ–› ⁄ò” Å—Ê›«?·.";
                                userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:red; color:white; padding:10px; border-radius:5px; z-index:10000;";
                                document.body.appendChild(userAlert);
                                setTimeout(() => userAlert.remove(), 3000);
                            } finally {
                                hideLoading();
                            }
                        });
                        document.body.appendChild(confirmModal);
                    } else {
                        const userAlert = document.createElement('div');
                        userAlert.textContent = "⁄ò”? »—«? Õ–› ÊÃÊœ ‰œ«—œ.";
                        userAlert.style.cssText = "position:fixed; top:10px; left:50%; transform:translateX(-50%); background:orange; color:white; padding:10px; border-radius:5px; z-index:10000;";
                        document.body.appendChild(userAlert);
                        setTimeout(() => userAlert.remove(), 3000);
                    }
                };
            }

            document.getElementById('portfolioImageUpload').onchange = (event) => {
                for (const file of event.target.files) {
                    uploadGalleryImage(file, 'portfolioImages');
                }
            };

            document.getElementById('classImageUpload').onchange = (event) => {
                 for (const file of event.target.files) {
                    uploadGalleryImage(file, 'classImages');
                }
            };
        }

        function makeTextsEditable(isEditable) {
            document.querySelectorAll('.editable-text').forEach(el => {
                el.contentEditable = isEditable;
                if (isEditable) {
                    el.onblur = () => {
                        const field = el.dataset.field;
                        const value = el.textContent.trim();
                        updateField(field, value);
                    };
                    el.classList.add('border', 'border-dashed', 'border-blue-400', 'p-1');
                } else {
                    el.onblur = null;
                    el.classList.remove('border', 'border-dashed', 'border-blue-400', 'p-1');
                }
            });
        }
        
        // Custom Confirm Modal
        function createConfirmModal(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10001;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:white; padding:20px; border-radius:8px; text-align:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.marginBottom = '20px';
            messageP.style.color = '#333'; // Darker text for better readability

            const confirmButton = document.createElement('button');
            confirmButton.textContent = ' «??œ';
            confirmButton.style.cssText = 'background-color:#4CAF50; color:white; padding:10px 15px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;';
            confirmButton.onclick = () => {
                onConfirm();
                modalOverlay.remove();
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = '«‰’—«›';
            cancelButton.style.cssText = 'background-color:#f44336; color:white; padding:10px 15px; border:none; border-radius:4px; cursor:pointer;';
            cancelButton.onclick = () => {
                modalOverlay.remove();
            };

            modalContent.appendChild(messageP);
            modalContent.appendChild(confirmButton);
            modalContent.appendChild(cancelButton);
            modalOverlay.appendChild(modalContent);

            return modalOverlay;
        }


        // --- Init ---
        document.getElementById('currentYear').textContent = new Date().getFullYear();

    </script>
</body>
</html>